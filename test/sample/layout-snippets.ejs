<%# å¤åˆ¶ä¸‹é¢ä¸€è¡Œåˆ°ä¸»é¢˜ layout å¯¹åº”é¡µé¢ï¼ˆå¦‚ tag.ejs / index.ejsï¼‰çš„ç©ºç™½å¤„ %>
<%# è‹¥æŠ¥é”™ã€Œforcegraph æœªå®šä¹‰ã€ï¼šå¯ä¸æ”¹ layoutï¼Œåœ¨ _config.yml çš„ forcegraph ä¸‹åŠ  inject: true ä¸ injectTo: ['tag']ï¼Œç”±æ’ä»¶è‡ªåŠ¨æ³¨å…¥å›¾è°± %>
<%- forcegraph('500px', '#111') %>
<%# å¯é€‰ï¼š<%- forcegraph('600px') %> æˆ– <%- forcegraph('500px', '#1a1a2e') %> %>


<!-- æ—§ç‰ˆæ‰‹åŠ¨æ¸²æŸ“ -->
<!-- å›¾è°±å®¹å™¨ -->
<div class="tags-graph-wrapper">
    <div class="graph-header">
      <h2 class="graph-title">ğŸ“Š çŸ¥è¯†å›¾è°±</h2>
      <p class="graph-legend">
        <span class="post-dot">â—</span> æ–‡ç«  
        <span class="tag-dot">â—</span> æ ‡ç­¾
      </p>
    </div>
    <div id="tags-graph-direct" class="graph-container">
      <div class="loading-message">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <!-- åŠ è½½ 3D å›¾è°±åº“ -->
  <script src="https://unpkg.com/3d-force-graph@1.70.13/dist/3d-force-graph.min.js"></script>

  <!-- æ¸²æŸ“å›¾è°± -->
  <script>
  (function() {
    console.log('ğŸ” å¼€å§‹æ¸²æŸ“çŸ¥è¯†å›¾è°±...');
    
    // è·å–æ–‡ç« æ•°æ®
    const posts = <%- JSON.stringify(site.posts.map(p => ({
      title: p.title,
      path: p.path,
      tags: p.tags ? p.tags.map(t => t.name) : []
    }))) %>;
    
    console.log('ğŸ“š æ–‡ç« æ•°é‡:', posts.length);
    
    const container = document.getElementById('tags-graph-direct');
    if (!container) {
      console.error('âŒ æ‰¾ä¸åˆ°å®¹å™¨å…ƒç´ ');
      return;
    }
    
    if (!posts || posts.length === 0) {
      container.innerHTML = '<div class="empty-message">æš‚æ— æ–‡ç« æ•°æ®</div>';
      return;
    }
    
    // å¼ºåˆ¶é‡è¯•æœºåˆ¶
    let retryCount = 0;
    const maxRetries = 5;
    
    function tryRender() {
      const width = container.clientWidth;
      const height = container.clientHeight;
      
      console.log(`ğŸ“ å°è¯• ${retryCount + 1}/${maxRetries} - å®¹å™¨å°ºå¯¸:`, width, 'x', height);
      
      if (width < 10 || height < 10) {
        retryCount++;
        if (retryCount < maxRetries) {
          console.log(`â³ å®¹å™¨å°ºå¯¸è¿‡å°ï¼Œ${retryCount * 200}msåé‡è¯•...`);
          setTimeout(tryRender, retryCount * 200);
        } else {
          container.innerHTML = '<div class="error-message">å®¹å™¨å°ºå¯¸å¼‚å¸¸</div>';
        }
        return;
      }
      
      // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½
      if (typeof ForceGraph3D === 'undefined') {
        console.error('âŒ ForceGraph3D åº“æœªåŠ è½½');
        container.innerHTML = '<div class="error-message">3D åº“åŠ è½½å¤±è´¥</div>';
        return;
      }
      
      renderGraph(width, height);
    }
    
    function renderGraph(width, height) {
      console.log('ğŸ¨ å¼€å§‹æ„å»ºå›¾è°±æ•°æ®...');
      
      // æ„å»ºå›¾è°±æ•°æ®
      const nodes = [];
      const links = [];
      const nodeMap = new Map();
      
      posts.forEach((post, idx) => {
        // æ–‡ç« èŠ‚ç‚¹
        const postId = 'p' + idx;
        nodeMap.set(postId, true);
        nodes.push({
          id: postId,
          name: post.title || 'æ— æ ‡é¢˜',
          type: 'post',
          url: post.path,
          val: 1
        });
        
        if (post.tags && post.tags.length) {
          // æ ‡ç­¾èŠ‚ç‚¹
          post.tags.forEach(tag => {
            const tagId = 't' + tag;
            if (!nodeMap.has(tagId)) {
              nodeMap.set(tagId, true);
              nodes.push({
                id: tagId,
                name: tag,
                type: 'tag',
                url: '/tags/' + encodeURIComponent(tag) + '/',
                val: 1.5
              });
            }
            // æ–‡ç« -æ ‡ç­¾è¿æ¥
            links.push({ source: postId, target: tagId });
          });
          
          // åŒä¸€ç¯‡æ–‡ç« çš„æ ‡ç­¾äº’ç›¸è¿æ¥
          for (let i = 0; i < post.tags.length; i++) {
            for (let j = i + 1; j < post.tags.length; j++) {
              links.push({
                source: 't' + post.tags[i],
                target: 't' + post.tags[j]
              });
            }
          }
        }
      });
      
      console.log('ğŸ“Š èŠ‚ç‚¹æ•°:', nodes.length, 'è¿æ¥æ•°:', links.length);
      
      if (nodes.length === 0) {
        container.innerHTML = '<div class="empty-message">æ— èŠ‚ç‚¹æ•°æ®</div>';
        return;
      }
      
      try {
        // æ¸…é™¤å®¹å™¨å†…å®¹
        container.innerHTML = '';
        
        // åˆ›å»ºå®¹å™¨
        const Graph = ForceGraph3D()(container)
          .graphData({ nodes, links })
          .nodeLabel(n => n.name)
          .nodeColor(n => n.type === 'post' ? '#ff7f0e' : '#1f77b4')
          .nodeVal(n => n.type === 'post' ? 4 : 2.5)
          .linkColor(() => 'rgba(255,255,255,0.15)')
          .linkWidth(0.5)
          .onNodeClick(n => window.location.href = n.url)
          .backgroundColor('#111')
          .enableNodeDrag(true)
          .enableNavigationControls(true)
          .width(width)
          .height(height);
        
        // è‡ªåŠ¨æ—‹è½¬
        if (Graph.controls) {
          Graph.controls().autoRotate = true;
          Graph.controls().autoRotateSpeed = 0.5;
        }
        
        console.log('âœ… å›¾è°±æ¸²æŸ“æˆåŠŸï¼');
        
        // æ·»åŠ çª—å£å¤§å°å˜åŒ–ç›‘å¬
        window.addEventListener('resize', function() {
          const newWidth = container.clientWidth;
          const newHeight = container.clientHeight;
          if (newWidth > 0 && newHeight > 0) {
            Graph.width(newWidth).height(newHeight);
          }
        });
        
      } catch (e) {
        console.error('âŒ æ¸²æŸ“å¤±è´¥:', e);
        container.innerHTML = '<div class="error-message">æ¸²æŸ“å¤±è´¥</div>';
      }
    }
    
    // å¼€å§‹æ¸²æŸ“
    if (document.readyState === 'complete') {
      tryRender();
    } else {
      window.addEventListener('load', tryRender);
    }
  })();
  </script>

  <style>
  .tags-graph-wrapper {
    margin-top: 1.5rem;
    padding: 0.8rem;
    background: var(--card-bg-color, #ffffff);
    border-radius: 10px;
    box-shadow: 0 1px 8px rgba(0,0,0,0.02);
  }
  
  .graph-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }
  
  .graph-title {
    margin: 0;
    font-size: 1rem;
    font-weight: 500;
  }
  
  .graph-legend {
    margin: 0;
    color: #999;
    font-size: 0.7rem;
  }
  
  .post-dot {
    color: #ff7f0e;
    margin-right: 2px;
  }
  
  .tag-dot {
    color: #1f77b4;
    margin-left: 6px;
    margin-right: 2px;
  }
  
  .graph-container {
    width: 100%;
    height: 250px;
    background: #111;
    border-radius: 6px;
    position: relative;
    overflow: hidden;
  }
  
  .loading-message, .empty-message, .error-message {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999;
    font-size: 0.9rem;
    background: #111;
    border-radius: 6px;
  }
  
  .error-message {
    color: #ff6b6b;
  }
  
  /* æš—è‰²æ¨¡å¼é€‚é… */
  [data-theme='dark'] .tags-graph-wrapper {
    background: #1a1a1a;
  }
  
  /* ç§»åŠ¨ç«¯é€‚é… */
  @media (max-width: 768px) {
    .graph-container {
      height: 180px;
    }
    .graph-title {
      font-size: 0.9rem;
    }
  }
  </style>
  
<% } else { %>
  <p style="text-align:center; padding:2rem;">æš‚æ— æ ‡ç­¾</p>